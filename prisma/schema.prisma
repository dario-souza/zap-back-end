generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  email             String             @unique
  phone             String?
  cpf       String?
  address           String?
  password          String
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  contacts          Contact[]
  messages          Message[]
  whatsappSessions  WhatsAppSession[]
  messageTemplates  MessageTemplate[]

  @@map("users")
}

model Contact {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  phone     String
  email     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  userId    String    @db.ObjectId
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId])
  @@map("contacts")
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  SCHEDULED
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
}

enum RecurrenceType {
  NONE
  MONTHLY
}

model Message {
  id                String         @id @default(auto()) @map("_id") @db.ObjectId
  content           String
  type              MessageType    @default(TEXT)
  status            MessageStatus  @default(PENDING)
  scheduledAt       DateTime?      @map("scheduled_at")
  sentAt            DateTime?      @map("sent_at")
  deliveredAt       DateTime?      @map("delivered_at")
  readAt            DateTime?      @map("read_at")
  externalId        String?        @map("external_id")
  recurrenceType    RecurrenceType @default(NONE) @map("recurrence_type")
  contactIds        String[]        @default([]) @map("contact_ids")
  originalMessageId String?        @db.ObjectId @map("original_message_id")
  isRecurringClone  Boolean        @default(false) @map("is_recurring_clone")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  userId            String         @db.ObjectId
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactId         String         @db.ObjectId
  contact           Contact        @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contactId])
  @@index([status])
  @@index([scheduledAt])
  @@map("messages")
}

enum WhatsAppSessionStatus {
  STOPPED
  STARTING
  SCAN_QR_CODE
  WORKING
  FAILED
}

model WhatsAppSession {
  id          String                @id @default(auto()) @map("_id") @db.ObjectId
  sessionId   String                @unique @map("session_id")
  name        String
  status      WhatsAppSessionStatus @default(STOPPED)
  phoneNumber String?               @map("phone_number")
  profileName String?               @map("profile_name")
  isDefault   Boolean               @default(false) @map("is_default")
  webhooksConfigured Boolean        @default(false) @map("webhooks_configured")
  createdAt   DateTime              @default(now()) @map("created_at")
  updatedAt   DateTime              @updatedAt @map("updated_at")
  userId      String                @db.ObjectId
  user        User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("whatsapp_sessions")
}

model MessageTemplate {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("message_templates")
}
